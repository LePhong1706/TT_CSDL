@model Web_vuottai.Models.DashboardViewModel
@{
    ViewData["Title"] = "Bảng điều khiển";
}

<main class="main-wrapper">
    <div class="main-content fade-in-on-load">
        <div class="page-breadcrumb d-none d-sm-flex align-items-center mb-3">
            <div class="ps-3">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb mb-0 p-0">
                        <li class="breadcrumb-item">
                            <a href="javascript:;"><i class="bx bx-home-alt"></i></a>
                        </li>
                        <li class="breadcrumb-item active" aria-current="page">Tổng quan</li>
                    </ol>
                </nav>
            </div>
        </div>
        <form method="get" asp-action="Index" class="row g-3 mb-4 align-items-end p-3 border rounded-3 ">
            <div class="col-md-5">
                <label for="namHoc" class="form-label fw-bold">Chọn Năm học</label>
                <select name="namHoc" class="form-select" asp-items="ViewBag.NamHocs"></select>
            </div>
            <div class="col-md-5">
                <label for="hocKy" class="form-label fw-bold">Chọn Học kỳ</label>
                <select name="hocKy" class="form-select" asp-items="ViewBag.HocKys"></select>
            </div>
            <div class="col-md-2 d-grid">
                <button type="submit" class="btn btn-primary">Lọc</button>
            </div>
        </form>
        <h6 class="mb-0 text-uppercase">Thống kê nhanh (@ViewBag.TermInfo)</h6>
        <hr>

        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
            <div class="col">
                <div class="card radius-10 card-hover">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Tổng Giảng viên</p>
                                <h4 class="my-1">@Model.TongGiangVien</h4>
                            </div>
                            <div class="widget-icon-large bg-gradient-primary text-white ms-auto">
                                <i class="material-icons-outlined">people</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card radius-10 card-hover">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Tổng Lớp</p>
                                <h4 class="my-1">@Model.TongLop</h4>
                            </div>
                            <div class="widget-icon-large bg-gradient-danger text-white ms-auto">
                                <i class="material-icons-outlined">class</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card radius-10 card-hover">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Tổng Giờ Vượt</p>
                                <h4 class="my-1">@Model.TongGioVuot.ToString("N2")</h4>
                            </div>
                            <div class="widget-icon-large bg-gradient-success text-white ms-auto">
                                <i class="material-icons-outlined">timer</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col">
                <div class="card radius-10 card-hover">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <p class="mb-0 text-secondary">Tổng Thanh Toán</p>
                                <h4 class="my-1">@Model.TongThanhTien.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</h4>
                            </div>
                            <div class="widget-icon-large bg-gradient-warning text-white ms-auto">
                                <i class="material-icons-outlined">payments</i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<h6 class="mb-0 text-uppercase">Truy cập nhanh</h6>
        <hr>
        <div class="row row-cols-1 row-cols-md-2 row-cols-xl-4">
            <div class="col">
                <a asp-controller="VuotTaiTongQuan" asp-action="Index" class="text-decoration-none">
                    <div class="card radius-10 card-hover">
                        <div class="card-body text-center">
                            <div class="widget-icon-large bg-gradient-info text-white mx-auto mb-3">
                                <i class="material-icons-outlined">insights</i>
                            </div>
                            <h5 class="card-title">Tổng quan Vượt tải</h5>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col">
                <a asp-controller="PhanCongChiTiet" asp-action="Index" class="text-decoration-none">
                    <div class="card radius-10 card-hover">
                        <div class="card-body text-center">
                            <div class="widget-icon-large bg-gradient-success text-white mx-auto mb-3">
                                <i class="material-icons-outlined">assignment_turned_in</i>
                            </div>
                            <h5 class="card-title">Phân công Chi tiết</h5>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col">
                <a asp-controller="GIANGVIENs" asp-action="Index" class="text-decoration-none">
                    <div class="card radius-10 card-hover">
                        <div class="card-body text-center">
                            <div class="widget-icon-large bg-gradient-primary text-white mx-auto mb-3">
                                <i class="material-icons-outlined">people</i>
                            </div>
                            <h5 class="card-title">Quản lý Giảng viên</h5>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col">
                <a asp-controller="LOPs" asp-action="Index" class="text-decoration-none">
                    <div class="card radius-10 card-hover">
                        <div class="card-body text-center">
                            <div class="widget-icon-large bg-gradient-danger text-white mx-auto mb-3">
                                <i class="material-icons-outlined">class</i>
                            </div>
                            <h5 class="card-title">Quản lý Lớp</h5>
                        </div>
                    </div>
                </a>
            </div>
        </div>
        <div class="row">
            <div class="col-12 col-xl-8">
                <div class="card radius-10 card-hover">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
    <div>
        <h5 class="mb-0">Top 5 Giảng viên Vượt tải (@ViewBag.TermInfo)</h5>
    </div>
</div>
<div style="height:400px; position: relative;"> <canvas id="barChartTopVuotTai"></canvas>
    <div id="barChartEmpty" style="display:none; position: absolute; top: 40%; left: 0; right: 0; text-align: center; color: #9a9a9a;">Không có dữ liệu vượt tải</div>
</div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-xl-4">
                <div class="card radius-10 card-hover">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div>
                                <h5 class="mb-0">Giờ giảng theo Đơn vị (@ViewBag.TermInfo)</h5>
                            </div>
                        </div>
                        <div class="mt-3" style="position: relative;"> <canvas id="pieChartDonVi"></canvas>
                            <div id="pieChartEmpty" style="display:none; position: absolute; top: 40%; left: 0; right: 0; text-align: center; color: #9a9a9a;">Không có dữ liệu giờ giảng</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
</main>
@section Scripts {
    <style>
        /* (Style .card-hover cũ của bạn) */
        .card-hover {
            transition: transform .3s ease, box-shadow .3s ease;
        }
        .card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 .5rem 1rem rgba(0,0,0,.15);
        }

        /* ===== CSS ANIMATION (Giữ nguyên) ===== */
        .fade-in-on-load {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        
        .fade-in-on-load.is-visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
<script>
    $(document).ready(function () {

        // ----- Đăng ký plugin Datalabels toàn cục -----
        Chart.register(ChartDataLabels);
        Chart.defaults.set('plugins.datalabels', {
            color: '#FFF', 
            anchor: 'end',
            align: 'top',
            font: {
                weight: 'bold'
            },
            formatter: function(value, context) {
                return value > 0 ? value : ''; 
            }
        });
        Chart.defaults.set('color', '#9a9a9a');

        // ----- Lấy màu từ CSS -----
        var style = getComputedStyle(document.documentElement);
        var primaryRgb = style.getPropertyValue('--bs-primary-rgb').trim();
        var successRgb = style.getPropertyValue('--bs-success-rgb').trim();
        var warningRgb = style.getPropertyValue('--bs-warning-rgb').trim();
        var dangerRgb = style.getPropertyValue('--bs-danger-rgb').trim();
        var infoRgb = style.getPropertyValue('--bs-info-rgb').trim();
        var primaryColor = style.getPropertyValue('--bs-primary').trim();
        var piePalette = [
            `rgba(${primaryRgb}, 0.8)`, `rgba(${successRgb}, 0.8)`,
            `rgba(${warningRgb}, 0.8)`, `rgba(${dangerRgb}, 0.8)`,
            `rgba(${infoRgb}, 0.8)`, 'rgba(130, 130, 130, 0.8)'
        ];

        // ----- 1. Biểu đồ Cột -----
        var barData = @Html.Raw(Json.Serialize(Model.TopVuotTaiChart.Data));
        if (barData.length === 0) {
            $('#barChartTopVuotTai').hide(); // Ẩn biểu đồ
            $('#barChartEmpty').show(); // Hiện thông báo
        } else {
            var barCtx = document.getElementById('barChartTopVuotTai').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.TopVuotTaiChart.Labels)),
                    datasets: [{
                        label: 'Số giờ vượt',
                        data: barData, // Sửa lại
                        backgroundColor: `rgba(${primaryRgb}, 0.6)`,
                        borderColor: primaryColor,
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#9a9a9a' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#9a9a9a' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#000',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) { label += context.parsed.y.toFixed(2) + ' giờ'; }
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            formatter: function(value, context) {
                                return value > 0 ? value.toFixed(2) : ''; 
                            }
                        }
                    }
                }
            });
        }

        // ----- 2. Biểu đồ Tròn -----
        var pieData = @Html.Raw(Json.Serialize(Model.DonViChart.Data));
        if (pieData.length === 0) {
            $('#pieChartDonVi').hide(); 
            $('#pieChartEmpty').show(); 
        } else {
            var pieCtx = document.getElementById('pieChartDonVi').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: @Html.Raw(Json.Serialize(Model.DonViChart.Labels)),
                    datasets: [{
                        label: 'Tổng giờ giảng',
                        data: pieData, // Sửa lại
                        backgroundColor: piePalette
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: '#9a9a9a' }
                        },
                        tooltip: {
                            backgroundColor: '#000',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) { label += context.parsed.toFixed(2) + ' giờ'; }
                                    return label;
                                }
                            }
                        },
                        // *** SỬA LỖI: DATALABELS PHẢI NẰM BÊN TRONG PLUGINS ***
                        datalabels: {
                            anchor: 'center', 
                            align: 'center',
                            color: '#FFF', 
                            font: { weight: 'bold' },
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1) + '%';
                                return (value * 100 / sum) > 5 ? percentage : '';
                            }
                        }
                        // *** KẾT THÚC SỬA LỖI ***
                    }
                }
            });
        }

        // *** SỬA LỖI: SETTIMEOUT PHẢI NẰM Ở NGOÀI CÙNG ***
        setTimeout(function() {
            $('.fade-in-on-load').addClass('is-visible');
        }, 100);
        // *** KẾT THÚC SỬA LỖI ***

    });
</script>
}